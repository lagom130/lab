# 共享申请记录异常
from datetime import date, timedelta, datetime

from bson import ObjectId
import pymongo


# dev
mongo_client = pymongo.MongoClient(host="mongo-0.mongo,mongo-1.mongo,mongo-2.mongo`", port=27017)
mongo_client.admin.authenticate('admin', '123@abcd', mechanism='SCRAM-SHA-1')
# 生产
# mongo_client = pymongo.MongoClient("2.46.2.239", 27017, username='admin', password='123@abcd', directConnection=True)

data_share_db = mongo_client["data_share_db"]
operation_record_collection = data_share_db["operation_record"]
data_resource_apply_collection = data_share_db["data_resource_apply"]


if __name__ == '__main__':
    data_ids=['5e858239ccb7e5000188949f',
'5e8582e7ccb7e500018894a2',
'5e858372ccb7e500018894a5',
'5e858428ccb7e500018894a8',
'5e8584d1ccb7e500018894ab',
'5e85856dccb7e500018894ae',
'5e8586ccccb7e500018894b1',
'5e86f8e5ccb7e500018895d4',
'5e86f92fccb7e500018895d7',
'5e86f9abccb7e500018895da',
'5e86fcc5ccb7e500018895e3',
'5e86fda3ccb7e500018895e6',
'5eb514e0f2e39d0001996fe3',
'5eb515e8f2e39d0001996fe4',
'5eb51634f2e39d0001996fe5',
'5eb51696f2e39d0001996fe6',
'5eb516ddf2e39d0001996fe7',
'5eb5171bf2e39d0001996fe8',
'5eb51765f2e39d0001996fe9',
'5eb51814f2e39d0001996fec',
'5eb5184bf2e39d0001996fed',
'5eb518bcf2e39d0001996fee',
'5eb518f4f2e39d0001996fef',
'5eb519bdf2e39d0001996ff0',
'5eb51a51f2e39d0001996ff1',
'5eb51abdf2e39d0001996ff2',
'5ec5eb380bb86900015a96bc',
'5ec5ec000bb86900015a96c0',
'5ec5ec780bb86900015a96c1',
'5ec5ece50bb86900015a96c2',
'5ec5ed410bb86900015a96c3',
'5ec619fc0bb86900015a9729',
'5ec61a710bb86900015a972a',
'5ec61ada0bb86900015a972b',
'5ec61b610bb86900015a972c',
'5ec61bc30bb86900015a972d',
'5ec61c230bb86900015a972e',
'5ec61c840bb86900015a972f',
'5ec61d580bb86900015a9732',
'5ec61da10bb86900015a9735',
'5ec61ddd0bb86900015a9736',
'5ec61e210bb86900015a9737',
'5ec61e7f0bb86900015a973a',
'5ec61ed10bb86900015a973f',
'5ec61fa40bb86900015a9746',
'5ecb678f782e8f00018bc7a4',
'5f17b576d6bed300019de332',
'5f17c32fd6bed300019de337',
'5f17c577d6bed300019de33d',
'5f17c644d6bed300019de340',
'5f17c92ed6bed300019de34b',
'5f17ca3ed6bed300019de35d',
'5f17ccbbd6bed300019de37a',
'5f17ce66d6bed300019de37b',
'5f17cf25d6bed300019de37c',
'5f27ce78ae7b70000151b590',
'5f4b8d6fe57f780001c2604c',
'5f4b8dd8e57f780001c2604f',
'5f4daafae57f780001c26068',
'5f4daf97e57f780001c26077',
'5f4db0cae57f780001c2607b',
'5f4db57ce57f780001c26098',
'5f4db67be57f780001c260a0',
'5f4db745e57f780001c260a4',
'5f632581f1d37b0001ec4d3b',
'5f632619f1d37b0001ec4d3e',
'5f63269bf1d37b0001ec4d41',
'5f63271ff1d37b0001ec4d44',
'5f632795f1d37b0001ec4d47',
'5f63284af1d37b0001ec4d4a',
'5f6b118af1d37b0001ec4ded',
'5f6b125ef1d37b0001ec4dee',
'5f6b12e6f1d37b0001ec4def',
'5f6b137ff1d37b0001ec4df0',
'5f6b145df1d37b0001ec4df1',
'5f6b14bbf1d37b0001ec4df2',
'5f86b66a5b4e090001fd51b8',
'5f86b7af5b4e090001fd51b9',
'5f86b8815b4e090001fd51ba',
'5f86b8e75b4e090001fd51bb',
'5f86b9895b4e090001fd51bc',
'5f86ba775b4e090001fd51bd',
'5f86bbe95b4e090001fd51be',
'5f926862b29463000104abe8',
'5f926912b29463000104abe9',
'5f996d61b29463000104ac21',
'5f996e5cb29463000104ac24',
'5f996ec4b29463000104ac27',
'5f996f73b29463000104ac2a',
'5f9970aeb29463000104ac2d',
'5fbde7cf1112d9000121ec66',
'5fbde8ed1112d9000121ec69',
'5fbde9481112d9000121ec6c',
'5fbde99d1112d9000121ec6f',
'5fbde9f81112d9000121ec72',
'5fc874f064caa100019c0ba8',
'5fc8752c64caa100019c0bab',
'5fc8757864caa100019c0bae',
'5fc875ac64caa100019c0bb1',
'5fc875e064caa100019c0bb4',
'5fc8761b64caa100019c0bb7',
'5fd1e47c64caa100019c1020',
'5fd1e65864caa100019c1023',
'5fd1e6cc64caa100019c1026',
'5fd1e74664caa100019c1029',
'5fd1e7aa64caa100019c102c',
'5fd1e86d64caa100019c102f',
'5fd1e8e364caa100019c1032',
'5fd1e96264caa100019c1035',
'5fd1e9d664caa100019c1038',
'5fd1ea3064caa100019c103b',
'5fd1eaa964caa100019c103e',
'5fd1eb2564caa100019c1041',
'5fd1eb7464caa100019c1044',
'5fd1ebd764caa100019c1047',
'5fd1ec3964caa100019c104a',
'5fd1ec9064caa100019c104d',
'5fd1ecef64caa100019c1050',
'5fd1ed4264caa100019c1053',
'5fd1edad64caa100019c1056',
'5fd1ee2764caa100019c1059',
'5fd1ee8464caa100019c105c',
'5fd1eeec64caa100019c105f',
'5fd1ef5d64caa100019c1062',
'5fd1efb864caa100019c1065',
'5fd1f02464caa100019c1068',
'5fd1f07964caa100019c106b',
'5fd1f0f864caa100019c1070',
'5fd1f1e464caa100019c1079',
'5fd2d37c64caa100019c107c',
'5fe0095c0a0783000126b439',
'5fe009ac0a0783000126b43c',
'5fe009e90a0783000126b43f',
'5fe00a1c0a0783000126b442',
'5fe00a5b0a0783000126b445',
'5fe00a990a0783000126b448',
'5fe00b250a0783000126b44b',
'5fe00b690a0783000126b44e',
'5fe00baf0a0783000126b451',
'5fe00bf50a0783000126b454',
'5fe00c2c0a0783000126b457',
'5fe00c850a0783000126b45a',
'5fe00d050a0783000126b45b',
'5fe00d940a0783000126b45e',
'5fe00dc60a0783000126b45f',
'5fe00dfb0a0783000126b460',
'5fe00e390a0783000126b461',
'5fe00e690a0783000126b462',
'5fe00e9a0a0783000126b463',
'5fe00ece0a0783000126b464',
'5fe00f060a0783000126b465',
'5fe00f3c0a0783000126b466',
'5fe0a6fe2c77e300012e1c34',
'5fe0a81d2c77e300012e1c35',
'5fe0a8ac2c77e300012e1c36',
'5fe0a8fb2c77e300012e1c37',
'5ff3adf33a0d630001c99288',
'5ff5116315bac2000116e879',
'5ff511bf15bac2000116e87a',
'5ff5120815bac2000116e87b',
'5ff5123a15bac2000116e87c',
'602dfe4a15bac2000116f393',
'602e0a359ece45000139abda',
'602e0a6c9ece45000139abdb',
'602e0ace9ece45000139abdc',
'602e0af89ece45000139abdd',
'602e0b269ece45000139abde',
'602e0b609ece45000139abdf',
'602e0b939ece45000139abe0',
'602e0be19ece45000139abe1',
'602e24279ece45000139ac25',
'602e246b9ece45000139ac26',
'602e24ad9ece45000139ac27',
'602e24ed9ece45000139ac28',
'602e25269ece45000139ac29',
'602e25699ece45000139ac2a',
'602e25be9ece45000139ac2b',
'60306cbf9ece45000139ad8f',
'603072c39ece45000139add6',
'603073059ece45000139add9',
'603073439ece45000139addc',
'603073889ece45000139addf',
'603073c39ece45000139ade2',
'603073fe9ece45000139ade5',
'6030743e9ece45000139ade8',
'6030747b9ece45000139adeb',
'603074b79ece45000139adee',
'6037013a9ece45000139b1e6',
'603701629ece45000139b1e7',
'6037018a9ece45000139b1e8',
'603701af9ece45000139b1e9',
'603701d39ece45000139b1ea',
'60383e329ece45000139b2a8',
'6086204bc78ed000011fa825',
'60862103c78ed000011fa826',
'60862170c78ed000011fa827',
'60c9b994f1d37b0001b3db68',
'612c7a3e2ca01400013e3b98',
'61627e3fcfc54b0001326260',
'62625d4245820e0001254fe8',
'627df2b445820e000125560d',
'628455ec45820e0001255736',
'628456b645820e000125573c',
'6284594a45820e000125574e',
'628459b945820e0001255757',
'62845a8645820e0001255769',
'62845bde45820e0001255787',
'62845c3545820e00012557ae',
'62845cc745820e00012557d6',
'62a9dcb353a1ef000190fa75',
'62aab48553a1ef000190fb0c',
'62ab27e753a1ef000190fbe9',
'62ab282353a1ef000190fbea',
'62ab292f53a1ef000190fbee',
'62ab2b201759da000136648f',
'62abdfe0a67a5f000180ed7a',
'62abebf8a67a5f000180ee43',
'62abec40a67a5f000180ee47',
'62abecaea67a5f000180ee4a',
'62abecf1a67a5f000180ee4b',
'62abed3ba67a5f000180ee4f',
'62abed83a67a5f000180ee53',
'62abeddca67a5f000180ee54',
'62abee1fa67a5f000180ee55',
'62abee70a67a5f000180ee56',
'62abeeb4a67a5f000180ee59',
'62abef09a67a5f000180ee5a',
'62abef58a67a5f000180ee5d',
'62abefa4a67a5f000180ee5e',
'62b94903d88187000188ce64',
'62b949a8d88187000188ce67',
'62b94a04d88187000188ce6a',
'62b94d49d88187000188ce71',
'62d76615367a3c0001dfc833',
'62d76dc0367a3c0001dfc974',
'62d76e0e367a3c0001dfc97c',
'62dfb06b6f1d5c00015c1680',
'62f3323bb0cd1a0001633050',
'62f9d0b9b0cd1a00016333e0',
'62f9d111b0cd1a00016333e1',
'62f9d160b0cd1a00016333e2',
'62f9d1fdb0cd1a00016333e4',
'62f9d247b0cd1a00016333e5',
'62fb27f4f10a860001a960c7',
'62fb28bbf10a860001a960cb',
'62fb2a49f10a860001a960d0',
'62fb2aa0f10a860001a960d1',
'62fb2af6f10a860001a960d2',
'62fb3218f10a860001a960d9',
'62fb3660f10a860001a960db',
'62fb36dff10a860001a960dc',
'62fb3788f10a860001a960de',
'62fb3a71f10a860001a960e4',
'62fb3ad6f10a860001a960e5',
'62fb3bc7f10a860001a960e7',
'62fb41e7f10a860001a960f1',
'62fb42cbf10a860001a960f4',
'62fb436cf10a860001a960fd',
'62fb4471f10a860001a96107',
'62fb49e3f10a860001a9610b',
'62fb4dbff10a860001a9610c',
'63203ee036686e00012024e1',
'63493bb85c05300001aff388',
'63607d165c05300001aff98d',
'63607e3f5c05300001aff9a8',
'6360ba635c05300001b0002c',
'637598615c05300001b05528',
'6375efae5c05300001b05670',
'6392fb3f8e34890001483d8c',
'640e78444867430001fb2cfa']
    # 根据字段分组条件查询
    pipeline = {'data_type': 'shareResourceApply','data_id':{'$in': data_ids}}
    result = operation_record_collection.find(pipeline).sort([('data_id',1),('created_time',-1)])

    apply_ids = []
    all_ids = []
    # 获取所有申请记录id
    for doc in result:
        if not doc["data_id"] in all_ids:
            all_ids.append(doc["data_id"])
            new_doc = doc
            new_doc.pop('_id')
            new_doc['data_status'] = doc['data_status'].split('|')[0]+"|finished"
            if 'operator_name' in doc:
                new_doc['content'] = doc['operator_name']+"推送资源"
            else:
                new_doc['content'] = "推送资源" 
            if 'created_time' in doc:
                if type(doc['created_time']) is str:
                    day_time= datetime.strptime(doc['created_time'], '%Y-%m-%d %H:%M:%S') + timedelta(days=1)
                    min_time = day_time + timedelta(minutes=10)
                    new_doc['created_time']=datetime.strftime(min_time, '%Y-%m-%d %H:%M:%S')
                else:
                    created_time = datetime.strftime(doc['created_time'], '%Y-%m-%d %H:%M:%S')
                    day_time= datetime.strptime(created_time, '%Y-%m-%d %H:%M:%S') + timedelta(days=1)
                    min_time = day_time + timedelta(minutes=10)
                    new_doc['created_time']=datetime.strftime(min_time, '%Y-%m-%d %H:%M:%S')
            else:
                new_doc['created_time']=datetime.strftime(datetime.now, '%Y-%m-%d %H:%M:%S')
            print(new_doc)
            operation_record_collection.insert_one(new_doc)
            apply_ids.append({'_id':ObjectId(doc["data_id"]),'update':new_doc['created_time']})

    for doc in apply_ids:
        print(doc)
        data_resource_apply_collection.update_one({'_id': doc['_id']}, {'$set': {'updated_time': doc['update']}})
